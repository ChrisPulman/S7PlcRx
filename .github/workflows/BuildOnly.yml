name: BuildOnly

on:
  push:
    branches-ignore:
      - main

jobs:
  build:
    name: build
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET (With cache)
        uses: actions/setup-dotnet@v5.0.1
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x
          dotnet-quality: 'preview'
          cache: true
          cache-dependency-path: |
            **/Directory.Packages.props
            **/*.sln
            **/*.csproj
            **/global.json
            **/nuget.config

      - name: Cache NUKE + NuGet
        uses: actions/cache@v5
        with:
          path: |
            .nuke/temp
            ~/.nuget/packages
          key: ${{ runner.os }}-${{ hashFiles('**/global.json', '**/*.csproj', '**/Directory.Packages.props') }}

      - name: Run NUKE Compile
        run: ./build.cmd Compile

  coverage:
    name: coverage
    runs-on: windows-latest
    needs: build

    env:
      CI: true
      DOTNET_MULTILEVEL_LOOKUP: 0

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Install ONLY .NET 8 for coverage to avoid hostfxr 10 preview being selected.
      - name: Setup .NET 8 (With cache)
        uses: actions/setup-dotnet@v5.0.1
        with:
          dotnet-version: 8.0.x
          cache: true
          cache-dependency-path: |
            **/Directory.Packages.props
            **/*.sln
            **/*.csproj
            **/global.json
            **/nuget.config

      - name: Run NUKE Coverage
        shell: pwsh
        run: |
          Write-Host "DOTNET_ROOT=$env:DOTNET_ROOT"
          $env:DOTNET_EXE = Join-Path $env:DOTNET_ROOT 'dotnet.exe'
          Write-Host "DOTNET_EXE=$env:DOTNET_EXE"
          & $env:DOTNET_EXE --info
          ./build.cmd Coverage

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.cobertura.xml

      - name: Publish coverage summary
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage.cobertura.xml
          badge: true
          format: markdown
          output: both
